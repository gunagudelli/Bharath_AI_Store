name: Generate Agent APK
on:
  repository_dispatch:
    types: [generate-apk]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: npm install
        
      - name: ðŸ”§ Setup EAS CLI
        run: npm install -g @expo/cli eas-cli
        
      - name: ðŸ”‘ EAS Authentication
        run: eas login --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          
      - name: ðŸ—ï¸ Configure Agent-Specific Build
        run: |
          echo "ðŸ”¥ Building APK for Agent: ${{ github.event.client_payload.agentName }}"
          echo "ðŸ“± Agent ID: ${{ github.event.client_payload.agentId }}"
          echo "ðŸ†” Build ID: ${{ github.event.client_payload.buildId }}"
          
          # Set agent-specific environment variables
          echo "EXPO_PUBLIC_AGENT_ID=${{ github.event.client_payload.agentId }}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_AGENT_NAME=${{ github.event.client_payload.agentName }}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_BUILD_ID=${{ github.event.client_payload.buildId }}" >> $GITHUB_ENV
          
      - name: ðŸ“ Update App Configuration
        run: |
          # Update app.json with agent-specific details
          node -e "
          const fs = require('fs');
          const appConfig = JSON.parse(fs.readFileSync('app.json', 'utf8'));
          const agentId = process.env.EXPO_PUBLIC_AGENT_ID;
          const agentName = process.env.EXPO_PUBLIC_AGENT_NAME;
          
          // Update app name and package
          appConfig.expo.name = agentName + ' AI';
          appConfig.expo.slug = 'bharath-ai-' + agentId.toLowerCase();
          appConfig.expo.android.package = 'com.bharathai.' + agentId.toLowerCase().replace(/[^a-z0-9]/g, '');
          
          fs.writeFileSync('app.json', JSON.stringify(appConfig, null, 2));
          console.log('âœ… App config updated for agent:', agentName);
          "
          
      - name: ðŸ—ï¸ Build APK with EAS
        run: |
          echo "ðŸš€ Starting APK build for ${{ github.event.client_payload.agentName }}..."
          eas build --platform android --profile agent-apk --non-interactive --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_PUBLIC_AGENT_ID: ${{ github.event.client_payload.agentId }}
          EXPO_PUBLIC_AGENT_NAME: ${{ github.event.client_payload.agentName }}
          EXPO_PUBLIC_BUILD_ID: ${{ github.event.client_payload.buildId }}
          
      - name: ðŸ“¤ Get Build Artifacts
        id: build-info
        run: |
          # Get the latest build info
          BUILD_INFO=$(eas build:list --platform android --limit 1 --json)
          BUILD_URL=$(echo $BUILD_INFO | jq -r '.[0].artifacts.buildUrl // empty')
          BUILD_STATUS=$(echo $BUILD_INFO | jq -r '.[0].status')
          
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT
          echo "ðŸ“± APK URL: $BUILD_URL"
          
      - name: ðŸ“¡ Notify Backend (Webhook)
        if: always()
        run: |
          curl -X POST "${{ secrets.WEBHOOK_URL }}/build-webhook" \
            -H "Content-Type: application/json" \
            -d '{
              "buildId": "${{ github.event.client_payload.buildId }}",
              "agentId": "${{ github.event.client_payload.agentId }}",
              "agentName": "${{ github.event.client_payload.agentName }}",
              "status": "${{ steps.build-info.outputs.build_status }}",
              "artifacts": {
                "apkUrl": "${{ steps.build-info.outputs.build_url }}"
              },
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
            
      - name: âœ… Build Complete
        run: |
          echo "ðŸŽ‰ APK build completed for ${{ github.event.client_payload.agentName }}"
          echo "ðŸ“± Download URL: ${{ steps.build-info.outputs.build_url }}"