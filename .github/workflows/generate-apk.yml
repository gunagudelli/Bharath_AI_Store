name: Generate Agent APK

on:
  repository_dispatch:
    types: [generate-apk]

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js (Expo requires Node 20 now)
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install dependencies with clean cache
      - name: Install dependencies
        run: |
          npm ci --legacy-peer-deps
          echo "Dependencies installed successfully"

      # 4Ô∏è‚É£ Install EAS CLI only
      - name: Install EAS CLI
        run: |
          npm install -g eas-cli@latest
          echo "Verifying EAS CLI installation..."
          npx eas --version

      # 5Ô∏è‚É£ Verify Expo authentication via token
      - name: Verify Expo Authentication
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: npx expo whoami

      # 5.5Ô∏è‚É£ Setup Android credentials if needed
      - name: Setup Android Credentials
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "üì± Checking Android credentials..."
          npx eas credentials --platform android --profile agent-apk || echo "Credentials already exist"

      # 6Ô∏è‚É£ Build APK using EAS with environment variables
      - name: Build APK with EAS
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_PUBLIC_AGENT_ID: ${{ github.event.client_payload.agentId }}
          EXPO_PUBLIC_AGENT_NAME: ${{ github.event.client_payload.agentName }}
          EXPO_PUBLIC_BUILD_ID: ${{ github.event.client_payload.buildId }}
        run: |
          echo "üî• Forwarding env vars to EAS cloud"
          echo "EXPO_PUBLIC_AGENT_ID: $EXPO_PUBLIC_AGENT_ID"
          echo "EXPO_PUBLIC_AGENT_NAME: $EXPO_PUBLIC_AGENT_NAME"
          echo "EXPO_PUBLIC_BUILD_ID: $EXPO_PUBLIC_BUILD_ID"
          echo "üì± Using Expo-managed credentials (remote)"
          npx eas build \
            --platform android \
            --profile agent-apk \
            --non-interactive \
            --no-wait

      # 7Ô∏è‚É£ Get APK download URL
      - name: Get APK Download URL
        id: get-apk
        run: |
          echo "üì• Getting APK download URL..."
          APK_DATA=$(npx eas build:list --platform=android --limit=1 --json)
          echo "Raw APK data: $APK_DATA"
          APK_URL=$(echo "$APK_DATA" | jq -r '.[0].artifacts.buildUrl // empty')
          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "‚ùå No APK URL found"
            APK_URL="https://expo.dev/artifacts/eas/build-not-found"
          fi
          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
          echo "üì± APK URL: $APK_URL"

      # 8Ô∏è‚É£ Notify backend on SUCCESS
      - name: Notify Backend Success
        if: success()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è WEBHOOK_URL not set, skipping notification"
            exit 0
          fi
          echo "üì° Notifying backend at: $WEBHOOK_URL"
          curl -v -X POST "$WEBHOOK_URL/build-webhook" \
            -H "Content-Type: application/json" \
            -d '{
              "buildId": "${{ github.event.client_payload.buildId }}",
              "agentId": "${{ github.event.client_payload.agentId }}",
              "agentName": "${{ github.event.client_payload.agentName }}",
              "status": "completed",
              "artifacts": {
                "apkUrl": "${{ steps.get-apk.outputs.apk_url }}"
              }
            }' || echo "‚ùå Failed to notify backend"

      # 9Ô∏è‚É£ Notify backend on FAILURE
      - name: Notify Backend Failure
        if: failure()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è WEBHOOK_URL not set, skipping notification"
            exit 0
          fi
          curl -X POST "$WEBHOOK_URL/build-webhook" \
            -H "Content-Type: application/json" \
            -d '{
              "buildId": "${{ github.event.client_payload.buildId }}",
              "agentId": "${{ github.event.client_payload.agentId }}",
              "agentName": "${{ github.event.client_payload.agentName }}",
              "status": "failed"
            }'
