name: Generate Agent APK

on:
  repository_dispatch:
    types: [generate-apk]

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Node setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install jq
      - name: Install system tools
        run: sudo apt-get update && sudo apt-get install -y jq

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install

      # 5Ô∏è‚É£ Install Expo & EAS
      - name: Install Expo & EAS
        run: |
          npm install -g @expo/cli@latest eas-cli@latest
          expo --version
          eas --version

      # 6Ô∏è‚É£ Set agent env variables
      - name: Configure Agent Environment
        run: |
          echo "EXPO_PUBLIC_AGENT_ID=${{ github.event.client_payload.agentId }}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_AGENT_NAME=${{ github.event.client_payload.agentName }}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_BUILD_ID=${{ github.event.client_payload.buildId }}" >> $GITHUB_ENV
          echo "üî• Building APK for agent: ${{ github.event.client_payload.agentName }}"

      # 7Ô∏è‚É£ Build APK
      - name: Build APK using EAS
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "üöÄ Starting EAS build..."
          eas build -p android --profile agent-apk --non-interactive --wait

      # 8Ô∏è‚É£ Fetch correct APK URL using BUILD_ID
      - name: Get APK Download URL
        id: get-apk
        run: |
          echo "üîç Fetching APK for BUILD_ID=${{ github.event.client_payload.buildId }}"

          BUILD_LIST=$(eas build:list --platform android --json)

          APK_URL=$(echo "$BUILD_LIST" | jq -r --arg BID "${{ github.event.client_payload.buildId }}" '
            map(select(.metadata.env.EXPO_PUBLIC_BUILD_ID == $BID))
            | sort_by(.createdAt)
            | last
            | .artifacts.applicationArchiveUrl
          ')

          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "‚ùå APK URL not found for this buildId"
            exit 1
          fi

          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ APK URL: $APK_URL"

      # 9Ô∏è‚É£ Notify backend SUCCESS
      - name: Notify Backend Success
        if: success()
        run: |
          curl -X POST "${{ secrets.WEBHOOK_URL }}/build-webhook" \
          -H "Content-Type: application/json" \
          -d '{
            "buildId": "${{ github.event.client_payload.buildId }}",
            "agentId": "${{ github.event.client_payload.agentId }}",
            "status": "completed",
            "apkUrl": "${{ steps.apk.outputs.apk_url }}"
          }'

      # üîü Notify backend FAILURE
      - name: Notify Backend Failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.WEBHOOK_URL }}/build-webhook" \
            -H "Content-Type: application/json" \
            -d '{
              "buildId": "${{ github.event.client_payload.buildId }}",
              "agentId": "${{ github.event.client_payload.agentId }}",
              "status": "failed"
            }'
