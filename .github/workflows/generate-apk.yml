name: Generate Agent APK

on:
  repository_dispatch:
    types: [generate-apk]

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Install Expo & EAS
        run: |
          npm install -g expo-cli eas-cli

      - name: Login to Expo
        run: expo whoami || expo login --token ${{ secrets.EXPO_TOKEN }}

      - name: Configure Agent App
        run: |
          echo "AGENT_ID=${{ github.event.client_payload.agentId }}" >> .env
          echo "AGENT_NAME=${{ github.event.client_payload.agentName }}" >> .env
          echo "BUILD_ID=${{ github.event.client_payload.buildId }}" >> .env

      - name: Build APK with EAS
        run: |
          eas build --platform android --profile production --non-interactive

      - name: Notify Backend (Webhook)
        run: |
          curl -X POST ${{ secrets.WEBHOOK_URL }}/apk-complete \
          -H "Content-Type: application/json" \
          -d '{
            "agentId": "${{ github.event.client_payload.agentId }}",
            "buildId": "${{ github.event.client_payload.buildId }}"
          }'
